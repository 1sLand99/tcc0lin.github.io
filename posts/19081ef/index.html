<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>终端流量对抗的经验总结 - 佛光普照</title><meta name="author" content="tcc0lin">
<meta name="description" content="本文聚焦终端流量的攻防对抗技术，分析系统代理、VPN隧道、网关抓包及libpcap抓包等流量控制手段的原理与限制，并探讨SSL/TLS中间人攻击、协议逆向、密钥提取等流量解密方法。通过技术对比与实例，揭示攻防双方在流量隐蔽、检测与反制中的动态博弈，为安全研究人员提供实践参考"><meta name="keywords" content='流量对抗'>
  <meta itemprop="name" content="终端流量对抗的经验总结">
  <meta itemprop="description" content="本文聚焦终端流量的攻防对抗技术，分析系统代理、VPN隧道、网关抓包及libpcap抓包等流量控制手段的原理与限制，并探讨SSL/TLS中间人攻击、协议逆向、密钥提取等流量解密方法。通过技术对比与实例，揭示攻防双方在流量隐蔽、检测与反制中的动态博弈，为安全研究人员提供实践参考">
  <meta itemprop="datePublished" content="2025-03-26T20:57:27+08:00">
  <meta itemprop="dateModified" content="2025-03-26T20:57:27+08:00">
  <meta itemprop="wordCount" content="10779">
  <meta itemprop="keywords" content="流量对抗"><meta property="og:url" content="http://localhost:1313/posts/19081ef/">
  <meta property="og:site_name" content="佛光普照">
  <meta property="og:title" content="终端流量对抗的经验总结">
  <meta property="og:description" content="本文聚焦终端流量的攻防对抗技术，分析系统代理、VPN隧道、网关抓包及libpcap抓包等流量控制手段的原理与限制，并探讨SSL/TLS中间人攻击、协议逆向、密钥提取等流量解密方法。通过技术对比与实例，揭示攻防双方在流量隐蔽、检测与反制中的动态博弈，为安全研究人员提供实践参考">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-03-26T20:57:27+08:00">
    <meta property="article:modified_time" content="2025-03-26T20:57:27+08:00">
    <meta property="article:tag" content="流量对抗">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="终端流量对抗的经验总结">
  <meta name="twitter:description" content="本文聚焦终端流量的攻防对抗技术，分析系统代理、VPN隧道、网关抓包及libpcap抓包等流量控制手段的原理与限制，并探讨SSL/TLS中间人攻击、协议逆向、密钥提取等流量解密方法。通过技术对比与实例，揭示攻防双方在流量隐蔽、检测与反制中的动态博弈，为安全研究人员提供实践参考">
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/tcc0lin_fav.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="http://localhost:1313/posts/19081ef/" title="终端流量对抗的经验总结 - 佛光普照" /><link rel="prev" type="text/html" href="http://localhost:1313/posts/e319adc/" title="TLS协议握手与协议组合的深度解构：从TLS协议到定制化加密协议的移动安全视角" /><link rel="alternate" type="text/markdown" href="http://localhost:1313/posts/19081ef/index.md" title="终端流量对抗的经验总结 - 佛光普照"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "终端流量对抗的经验总结",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/localhost:1313\/posts\/19081ef\/"
    },"genre": "posts","keywords": "流量对抗","wordcount":  10779 ,
    "url": "http:\/\/localhost:1313\/posts\/19081ef\/","datePublished": "2025-03-26T20:57:27+08:00","dateModified": "2025-03-26T20:57:27+08:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "tcc0lin"
      },"description": ""
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper" data-github-corner="right">
    <div class="header-title">
      <a href="/" title="佛光普照"><span class="header-title-text">tcc0lin&#39;s security blog</span></a><span class="typeit header-subtitle"><template>佛光普照，威胁无处遁形</template></span></div>
    <nav>
      <ul class="menu"><li class="menu-item has-children">
              <a class="menu-link" href="/documentation/"><i class="fa-regular fa-newspaper fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> 文档</a><i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden="true"></i>
                <ul class="sub-menu"><li class="menu-item">
                        <a class="menu-link" href="/archives/"><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 归档</a>
                      </li><li class="menu-item">
                        <a class="menu-link" href="/categories/"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> 分类</a>
                      </li><li class="menu-item">
                        <a class="menu-link" href="/collections/"><i class="fa-solid fa-layer-group fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> 合集</a>
                      </li><li class="menu-item">
                        <a class="menu-link" href="/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a>
                      </li></ul></li><li class="menu-item">
              <a class="menu-link" href="/showcase/"><i class="fa-solid fa-blog fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> 案例展示</a></li><li class="menu-item">
              <a class="menu-link" href="/thinks/"><i class="fa-solid fa-brain fa-fw fa-sm" aria-hidden="true"></i> 近期思考</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容……" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="佛光普照"><span class="header-title-text">tcc0lin&#39;s security blog</span></a><span class="typeit header-subtitle"><template>佛光普照，威胁无处遁形</template></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容……" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li class="menu-item"><span class="nested-item">
                  <a class="menu-link" href="/documentation/"><i class="fa-regular fa-newspaper fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> 文档</a>
                  <i class="dropdown-icon fa-solid fa-chevron-right" aria-hidden="true"></i>
                </span>
                <ul class="sub-menu"><li class="menu-item">
                        <a class="menu-link" href="/archives/"><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 归档</a>
                      </li><li class="menu-item">
                        <a class="menu-link" href="/categories/"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> 分类</a>
                      </li><li class="menu-item">
                        <a class="menu-link" href="/collections/"><i class="fa-solid fa-layer-group fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> 合集</a>
                      </li><li class="menu-item">
                        <a class="menu-link" href="/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a>
                      </li></ul></li><li class="menu-item"><a class="menu-link" href="/showcase/"><i class="fa-solid fa-blog fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> 案例展示</a></li><li class="menu-item"><a class="menu-link" href="/thinks/"><i class="fa-solid fa-brain fa-fw fa-sm" aria-hidden="true"></i> 近期思考</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><nav aria-label="breadcrumb" class="breadcrumb-container sticky">
    <ol class="breadcrumb"><li class="breadcrumb-item" data-separator="/"><a href="/" title="佛光普照">主页</a></li><li class="breadcrumb-item" data-separator="/"><a href="/posts/" title="Posts">文章</a></li><li class="breadcrumb-item active" data-separator="/" aria-current="page">终端流量对抗的经验总结</li>
    </ol>
  </nav><main class="container container-reverse"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span title="转载" class="icon-repost"><i class="fa-solid fa-share fa-fw" aria-hidden="true"></i></span><span>终端流量对抗的经验总结</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><img loading="lazy" src="/tcc0lin.png" alt="tcc0lin" data-title="tcc0lin" width="20" height="20" class="avatar" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/>&nbsp;tcc0lin</span></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" class="post-category" title="分类 - 网络协议"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> 网络协议</a></span></div><div class="post-meta-line"><span title="发布于 2025-03-26 20:57:27"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2025-03-26">2025-03-26</time></span>&nbsp;<span title="10779 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 10800 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 22 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#一网络流量形态分析">一、网络流量形态分析</a></li>
    <li><a href="#二流量抓取">二、流量抓取</a>
      <ul>
        <li><a href="#21-应用层系统代理">2.1 应用层：系统代理</a>
          <ul>
            <li><a href="#211-原理">2.1.1 原理</a></li>
            <li><a href="#212-使用方式">2.1.2 使用方式</a></li>
            <li><a href="#213-防御与对抗">2.1.3 防御与对抗</a></li>
          </ul>
        </li>
        <li><a href="#22-网络层虚拟网卡vpn">2.2 网络层：虚拟网卡VPN</a>
          <ul>
            <li><a href="#221-原理">2.2.1 原理</a></li>
            <li><a href="#222-使用方式">2.2.2 使用方式</a></li>
            <li><a href="#223-防御与对抗">2.2.3 防御与对抗</a></li>
          </ul>
        </li>
        <li><a href="#23-数据链路层网关路由">2.3 数据链路层：网关（路由）</a>
          <ul>
            <li><a href="#231-原理">2.3.1 原理</a></li>
            <li><a href="#232-使用方式">2.3.2 使用方式</a></li>
            <li><a href="#233-防御与对抗">2.3.3 防御与对抗</a></li>
          </ul>
        </li>
        <li><a href="#24-数据链路层libpcap">2.4 数据链路层：libpcap</a>
          <ul>
            <li><a href="#241-原理">2.4.1 原理</a></li>
            <li><a href="#242-使用方式">2.4.2 使用方式</a></li>
            <li><a href="#243-防御与对抗">2.4.3 防御与对抗</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#三协议解析">三、协议解析</a>
      <ul>
        <li><a href="#31-根证书">3.1 根证书</a></li>
        <li><a href="#32-ssl-keylog">3.2 SSL keylog</a></li>
        <li><a href="#33-ssl-readwrite">3.3 SSL read/write</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>在移动端逆向工程领域，网络流量分析始终是攻防博弈的核心战场。作为安全研究人员，网络流量是破解应用行为逻辑的关键突破口，分析者需要运用多层级抓包技术（数据链路层WiFi热点镜像、传输层tcpdump全流量捕获、应用层Charles/Fiddler MITM攻击）还原通信全貌，通过解析HTTPS握手过程、API调用时序、数据加密特征等关键信息，逆向推导出客户端加密算法、接口鉴权机制等风控系统核心逻辑。</p>
<p>面对日益严峻的黑产威胁，主流应用已构建起多维防御体系：在协议层面强制SSL Pinning锁定证书链，结合双向证书校验阻断代理工具中间人攻击；采用私有二进制协议封装数据，在TLS加密层之上叠加动态密钥协商机制，使传统抓包工具难以直接解析明文；不断升级的网络协议（QUIC），在提升传输效率的同时也持续提升协议分析的门槛。</p>
<p>因此，合理有效的终端流量对抗将会极大提升逆向分析的效率，让安全研究人员可以更加专注投入的代码分析中，下面是笔者在分析众多<code>Android</code> app协议的过程中所使用的工具迭代及尝试总结的经验。</p>
<h2 id="一网络流量形态分析" class="heading-element"><span>一、网络流量形态分析</span>
  <a href="#%e4%b8%80%e7%bd%91%e7%bb%9c%e6%b5%81%e9%87%8f%e5%bd%a2%e6%80%81%e5%88%86%e6%9e%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>在展开技术论述前，需首先明确网络流量的典型形态。若排除物理层射频信号分析、硬件调试接口（如JTAG）等特殊场景，商业环境中的网络通信多基于通用协议栈构建。</p>
<p>早期以HTTP为代表的明文传输协议因易受运营商劫持、中间人攻击等风险，已逐渐被TLS加密技术取代，成为现代网络隐私保护的核心机制。尽管HTTP协议持续迭代（如HTTP/1.1、HTTP/2及厂商定制的QUIC协议），其本质仍属于传输层与应用层协议的范畴。</p>
<p>对于安全研究而言，无论是流量抓取（如抓包技术）还是协议解析（如解密与逆向工程），均需突破协议封装与加密逻辑的双重屏障。下文将基于流量捕获与协议解析两大技术维度，系统剖析攻防对抗的核心路径。</p>
<h2 id="二流量抓取" class="heading-element"><span>二、流量抓取</span>
  <a href="#%e4%ba%8c%e6%b5%81%e9%87%8f%e6%8a%93%e5%8f%96" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>对应我们日常所说的“抓包”。</p>
<h3 id="21-应用层系统代理" class="heading-element"><span>2.1 应用层：系统代理</span>
  <a href="#21-%e5%ba%94%e7%94%a8%e5%b1%82%e7%b3%bb%e7%bb%9f%e4%bb%a3%e7%90%86" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>这是最为简单也是最为常用的一种抓包方案，也是大多数人在接触抓包时最初接触到的方案。在Android、iOS、macOS这些操作系统中连接WiFi时可以指定我们自定义的HTTP代理地址。如果应用使用了是系统提供的网络库或者遵循这个代理配置，那么就会将HTTP(S)请求通过该代理进行发送。</p>
<h4 id="211-原理" class="heading-element"><span>2.1.1 原理</span>
  <a href="#211-%e5%8e%9f%e7%90%86" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>以<code>Android11</code>代码为例，当我们在这么操作：<strong>设置→WLAN→长按具体的WIFI名→修改网络→手动代理或自动代理</strong>之后，最终会调用到<code>ConnectivityService</code>的<code>updateLinkProperties</code>函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// file: packages/modules/Connectivity/service/src/com/android/server/ConnectivityService.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateLinkProperties</span><span class="p">(</span><span class="n">NetworkAgentInfo</span><span class="w"> </span><span class="n">networkAgent</span><span class="p">,</span><span class="w"> </span><span class="nd">@NonNull</span><span class="w"> </span><span class="n">LinkProperties</span><span class="w"> </span><span class="n">newLp</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nd">@NonNull</span><span class="w"> </span><span class="n">LinkProperties</span><span class="w"> </span><span class="n">oldLp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isDefaultNetwork</span><span class="p">(</span><span class="n">networkAgent</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">handleApplyDefaultProxy</span><span class="p">(</span><span class="n">newLp</span><span class="p">.</span><span class="na">getHttpProxy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">updateProxy</span><span class="p">(</span><span class="n">newLp</span><span class="p">,</span><span class="w"> </span><span class="n">oldLp</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>最终会进入执行更新代理的操作，这里判断了当前更新的网络是否是默认（正在使用的网络），如果是则需要将此代理设置为默认代理，否则只通知更新即可。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// file: packages/modules/Connectivity/service/src/com/android/server/connectivity/ProxyTracker.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendProxyBroadcast</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">ProxyInfo</span><span class="w"> </span><span class="n">defaultProxy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getDefaultProxy</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">ProxyInfo</span><span class="w"> </span><span class="n">proxyInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">defaultProxy</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">defaultProxy</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProxyInfo</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mPacManager</span><span class="p">.</span><span class="na">setCurrentProxyScriptUrl</span><span class="p">(</span><span class="n">proxyInfo</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PacManager</span><span class="p">.</span><span class="na">DONT_SEND_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;sending Proxy Broadcast for &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">proxyInfo</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Intent</span><span class="p">(</span><span class="n">Proxy</span><span class="p">.</span><span class="na">PROXY_CHANGE_ACTION</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">intent</span><span class="p">.</span><span class="na">addFlags</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_REPLACE_PENDING</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_REGISTERED_ONLY_BEFORE_BOOT</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">intent</span><span class="p">.</span><span class="na">putExtra</span><span class="p">(</span><span class="n">Proxy</span><span class="p">.</span><span class="na">EXTRA_PROXY_INFO</span><span class="p">,</span><span class="w"> </span><span class="n">proxyInfo</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ident</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Binder</span><span class="p">.</span><span class="na">clearCallingIdentity</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mContext</span><span class="p">.</span><span class="na">sendStickyBroadcastAsUser</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">ALL</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Binder</span><span class="p">.</span><span class="na">restoreCallingIdentity</span><span class="p">(</span><span class="n">ident</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>通知代理更新时主要工作是发送了<code>PROXY_CHANGE_ACTION</code>的广播，而这个类型的广播在AMS中注册</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// file: frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">case</span><span class="w"> </span><span class="n">Proxy</span><span class="p">.</span><span class="na">PROXY_CHANGE_ACTION</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mHandler</span><span class="p">.</span><span class="na">sendMessage</span><span class="p">(</span><span class="n">mHandler</span><span class="p">.</span><span class="na">obtainMessage</span><span class="p">(</span><span class="n">UPDATE_HTTP_PROXY_MSG</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">case</span><span class="w"> </span><span class="n">UPDATE_HTTP_PROXY_MSG</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mProcessList</span><span class="p">.</span><span class="na">setAllHttpProxy</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// file: frameworks/base/services/core/java/com/android/server/am/ProcessList.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kt">void</span><span class="w"> </span><span class="nf">setAllHttpProxy</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Update the HTTP proxy for each application thread.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mService</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mLruProcesses</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ProcessRecord</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mLruProcesses</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// Don&#39;t dispatch to isolated processes as they can&#39;t access ConnectivityManager and</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// don&#39;t have network privileges anyway. Exclude system server and update it</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// separately outside the AMS lock, to avoid deadlock with Connectivity Service.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">pid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ActivityManagerService</span><span class="p">.</span><span class="na">MY_PID</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">thread</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">r</span><span class="p">.</span><span class="na">isolated</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">r</span><span class="p">.</span><span class="na">thread</span><span class="p">.</span><span class="na">updateHttpProxy</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Failed to update http proxy for: &#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">info</span><span class="p">.</span><span class="na">processName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ActivityThread</span><span class="p">.</span><span class="na">updateHttpProxy</span><span class="p">(</span><span class="n">mService</span><span class="p">.</span><span class="na">mContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// file: frameworks/base/core/java/android/app/ActivityThread.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateHttpProxy</span><span class="p">(</span><span class="nd">@NonNull</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="kd">final</span><span class="w"> </span><span class="n">ConnectivityManager</span><span class="w"> </span><span class="n">cm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConnectivityManager</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="n">context</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">Proxy</span><span class="p">.</span><span class="na">setHttpProxySystemProperty</span><span class="p">(</span><span class="n">cm</span><span class="p">.</span><span class="na">getDefaultProxy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>广播处理的结果是调用到<code>Proxy</code>类中设置代理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// file: frameworks/base/core/java/android/net/Proxy.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setHttpProxySystemProperty</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">host</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">exclList</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Uri</span><span class="w"> </span><span class="n">pacFileUrl</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exclList</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="n">exclList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exclList</span><span class="p">.</span><span class="na">replace</span><span class="p">(</span><span class="s">&#34;,&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;|&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;setHttpProxySystemProperty :&#34;</span><span class="o">+</span><span class="n">host</span><span class="o">+</span><span class="s">&#34;:&#34;</span><span class="o">+</span><span class="n">port</span><span class="o">+</span><span class="s">&#34; - &#34;</span><span class="o">+</span><span class="n">exclList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">host</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="s">&#34;http.proxyHost&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="s">&#34;https.proxyHost&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">clearProperty</span><span class="p">(</span><span class="s">&#34;http.proxyHost&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">clearProperty</span><span class="p">(</span><span class="s">&#34;https.proxyHost&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">port</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="s">&#34;http.proxyPort&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="s">&#34;https.proxyPort&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">clearProperty</span><span class="p">(</span><span class="s">&#34;http.proxyPort&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">clearProperty</span><span class="p">(</span><span class="s">&#34;https.proxyPort&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exclList</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="s">&#34;http.nonProxyHosts&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">exclList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="s">&#34;https.nonProxyHosts&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">exclList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">clearProperty</span><span class="p">(</span><span class="s">&#34;http.nonProxyHosts&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">clearProperty</span><span class="p">(</span><span class="s">&#34;https.nonProxyHosts&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">Uri</span><span class="p">.</span><span class="na">EMPTY</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">pacFileUrl</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ProxySelector</span><span class="p">.</span><span class="na">setDefault</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">PacProxySelector</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ProxySelector</span><span class="p">.</span><span class="na">setDefault</span><span class="p">(</span><span class="n">sDefaultProxySelector</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>从代码中可以看到，设置系统代理底层最终调用到的是<code>System.setProperty(&quot;http.proxyHost&quot;, host);</code></p>
<p>那么除了手动设置以外，还可以通过adb shell直接设置代理，例如</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 代理设置</span>
</span></span><span class="line"><span class="cl">adb shell settings put global http_proxy &lt;代理IP&gt;:&lt;端口&gt;
</span></span><span class="line"><span class="cl"><span class="c1"># 代理生效验证</span>
</span></span><span class="line"><span class="cl">adb shell settings get global http_proxy
</span></span><span class="line"><span class="cl"><span class="c1"># 清除代理</span>
</span></span><span class="line"><span class="cl">adb shell settings put global http_proxy null</span></span></code></pre></td></tr></table>
</div>
</div><p>当设置好代理后，App发起请求时系统会对<code>Host</code>和<code>Port</code>进行替换</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// file: external/okhttp/okhttp/src/main/java/com/squareup/okhttp/internal/http/RouteSelector.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">resetNextInetSocketAddress</span><span class="p">(</span><span class="n">Proxy</span><span class="w"> </span><span class="n">proxy</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Clear the addresses. Necessary if getAllByName() below throws!</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">inetSocketAddresses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">socketHost</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">socketPort</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">proxy</span><span class="p">.</span><span class="na">type</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Proxy</span><span class="p">.</span><span class="na">Type</span><span class="p">.</span><span class="na">DIRECT</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">proxy</span><span class="p">.</span><span class="na">type</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Proxy</span><span class="p">.</span><span class="na">Type</span><span class="p">.</span><span class="na">SOCKS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">socketHost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">address</span><span class="p">.</span><span class="na">getUriHost</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">socketPort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">address</span><span class="p">.</span><span class="na">getUriPort</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">SocketAddress</span><span class="w"> </span><span class="n">proxyAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proxy</span><span class="p">.</span><span class="na">address</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">proxyAddress</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">InetSocketAddress</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s">&#34;Proxy.address() is not an &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;InetSocketAddress: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">proxyAddress</span><span class="p">.</span><span class="na">getClass</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">InetSocketAddress</span><span class="w"> </span><span class="n">proxySocketAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">InetSocketAddress</span><span class="p">)</span><span class="w"> </span><span class="n">proxyAddress</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">socketHost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getHostString</span><span class="p">(</span><span class="n">proxySocketAddress</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">socketPort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proxySocketAddress</span><span class="p">.</span><span class="na">getPort</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="212-使用方式" class="heading-element"><span>2.1.2 使用方式</span>
  <a href="#212-%e4%bd%bf%e7%94%a8%e6%96%b9%e5%bc%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>由于系统代理通常只能拦截到HTTP(S)类型的流量，因此大部分都是配合传统抓包软件Burpsuite、Fiddler、Charles这类的工具使用，由其作为代理服务器，将设备流量转发到代理服务器上。</p>
<p>整体上配置简单，且对于流量的格式化、重放攻击、代码转化都已经优化的十分贴合用户，也成为大部分安全研究人员的第一任工具。当然，对于非HTTP的其他协议支持可能就不是很完善了。</p>
<h4 id="213-防御与对抗" class="heading-element"><span>2.1.3 防御与对抗</span>
  <a href="#213-%e9%98%b2%e5%be%a1%e4%b8%8e%e5%af%b9%e6%8a%97" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>本质上系统代理是<code>Android</code>提供的一个代理机制，就好比AOSP和三方厂商一样，&ldquo;规范&quot;和&quot;实际&quot;是两回事，因此也带来了这种方式的一个最明显的缺点：应用可能不按规矩来。不管是设置的系统代理，还是通过 <code>HTTP_PROXY</code> 环境变量指定代理，都只是一种<strong>约定俗成</strong>的规则而已。很多网络库都提供了额外的配置选项来让App可以指定或者忽略任何系统代理，例如</p>
<ul>
<li><strong>okhttp</strong>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">var</span> <span class="n">mOkHttpClientBuilder</span> <span class="o">=</span> <span class="n">OkHttpClient</span><span class="o">.</span><span class="n">Builder</span><span class="p">()</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">Proxy</span><span class="o">.</span><span class="n">NO_PROXY</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li><strong>HttpURLConnection</strong>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">httpurlconnection.openconnection(Proxy.NO_PROXY)</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>原理是当请求失败时会调用<code>httpEngine.recover</code>将失败的<code>proxy</code>加入<code>RouteSelector</code>内并对请求进行重试，而重试时因为之前已经将<code>proxy</code>加入黑名单中，因此可以直接进行请求，不走代理。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// file: external/okhttp/okhttp/src/main/java/com/squareup/okhttp/internal/http/RouteSelector.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Route</span><span class="w"> </span><span class="nf">next</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Compute the next route to attempt.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">hasNextInetSocketAddress</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">hasNextProxy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">hasNextPostponed</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">NoSuchElementException</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">nextPostponed</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">lastProxy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nextProxy</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">lastInetSocketAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nextInetSocketAddress</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">Route</span><span class="w"> </span><span class="n">route</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Route</span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">lastProxy</span><span class="p">,</span><span class="w"> </span><span class="n">lastInetSocketAddress</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">routeDatabase</span><span class="p">.</span><span class="na">shouldPostpone</span><span class="p">(</span><span class="n">route</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">postponedRoutes</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">route</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// We will only recurse in order to skip previously failed routes. They will be tried last.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">next</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">route</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>另一方面某些风控SDK会通过主动检测<code>http.proxyHost</code>和<code>https.proxyPort</code>等属性来判断系统是否使用了系统代理从而完成对这种方式的绕过。</p>
<p>从上文可以看出来由于系统提供了App绕过代理的方式，因此仅仅是基于系统代理的方式并不能保证抓取到完整的流量，除了主动分析hook掉之外还可以选择其他的抓取方式。</p>
<h3 id="22-网络层虚拟网卡vpn" class="heading-element"><span>2.2 网络层：虚拟网卡VPN</span>
  <a href="#22-%e7%bd%91%e7%bb%9c%e5%b1%82%e8%99%9a%e6%8b%9f%e7%bd%91%e5%8d%a1vpn" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>既然在应用层的系统代理会很轻易地被App绕过，那就继续下钻深入的传输层、数据链路层试试，这里所使用的技术是虚拟网卡，也就是通常所说的&quot;VPN&rdquo;</p>
<p>VPN实现原理就是在本地运行一个<strong>虚拟专用网络</strong>，构建一个虚拟网卡设备，并将路由规则修改为优先通过我们虚拟的网卡进行请求。比如，Android上可以通过实现VPNService去构建自己的VPN服务，postern就是一个很直观的案例，不过postern没有开源，可以另外参考<a href="https://github.com/MegatronKing/NetBare-Android"target="_blank" rel="external nofollow noopener noreferrer">NetBare-Android</a>的实现。</p>
<h4 id="221-原理" class="heading-element"><span>2.2.1 原理</span>
  <a href="#221-%e5%8e%9f%e7%90%86" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>VpnService是开发Android VPN的基础，下面是<a href="https://developer.android.com/reference/android/net/VpnService"target="_blank" rel="external nofollow noopener noreferrer">官方文档</a>的阐释</p>
<blockquote>
<p>VpnService is a base class for applications to extend and build their own VPN solutions. In general, it creates a virtual network interface, configures addresses and routing rules, and returns a file descriptor to the application. Each read from the descriptor retrieves an outgoing packet which was routed to the interface. Each write to the descriptor injects an incoming packet just like it was received from the interface. The interface is running on Internet Protocol (IP), so packets are always started with IP headers. The application then completes a VPN connection by processing and exchanging packets with the remote server over a tunnel.</p></blockquote>
<p>上面的阐释的重点是：</p>
<ul>
<li>创建​<strong>虚拟网络接口</strong>​（虚拟网卡），负责捕获和注入网络数据包。</li>
<li>接口基于<strong>IP协议</strong>，数据包始终以IP头开始。</li>
</ul>
<p>官方也提供了Example：<a href="https://android.googlesource.com/platform/development/&#43;/master/samples/ToyVpn"target="_blank" rel="external nofollow noopener noreferrer">ToyVpn</a>，概述就是调用VpnService类的<code>establish()</code>方法会获取到一个fd，通过读取fd就能获取到ip数据报文。</p>
<p>简单从源码角度来看看</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// file: frameworks/base/core/java/android/net/VpnService.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">ParcelFileDescriptor</span><span class="w"> </span><span class="nf">establish</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mConfig</span><span class="p">.</span><span class="na">addresses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mAddresses</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mConfig</span><span class="p">.</span><span class="na">routes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mRoutes</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getService</span><span class="p">().</span><span class="na">establishVpn</span><span class="p">(</span><span class="n">mConfig</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>调用了ConnectivityService 这个系统服务的 <code>establishVpn(mConfig)</code>方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// file: frameworks/base/services/core/java/com/android/server/ConnectivityService.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">protected</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">SparseArray</span><span class="o">&lt;</span><span class="n">Vpn</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mVpns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SparseArray</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">  * Configure a TUN interface and return its file descriptor. Parameters
</span></span></span><span class="line"><span class="cl"><span class="cm">  * are encoded and opaque to this class. This method is used by VpnBuilder
</span></span></span><span class="line"><span class="cl"><span class="cm">  * and not available in ConnectivityManager. Permissions are checked in
</span></span></span><span class="line"><span class="cl"><span class="cm">  * Vpn class.
</span></span></span><span class="line"><span class="cl"><span class="cm">  * @hide
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="n">ParcelFileDescriptor</span><span class="w"> </span><span class="nf">establishVpn</span><span class="p">(</span><span class="n">VpnConfig</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="kt">int</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(</span><span class="n">Binder</span><span class="p">.</span><span class="na">getCallingUid</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mVpns</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">throwIfLockdownEnabled</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="n">mVpns</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">user</span><span class="p">).</span><span class="na">establish</span><span class="p">(</span><span class="n">config</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>选择具体Vpn对象来处理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// file: frameworks/base/services/core/java/com/android/server/connectivity/Vpn.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="n">ParcelFileDescriptor</span><span class="w"> </span><span class="nf">establish</span><span class="p">(</span><span class="n">VpnConfig</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// Check if the caller is already prepared.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// Check to ensure consent hasn&#39;t been revoked since we were prepared.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// Check if the service is properly declared.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// Configure the interface. Abort if any of these steps fails.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ParcelFileDescriptor</span><span class="w"> </span><span class="n">tun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ParcelFileDescriptor</span><span class="p">.</span><span class="na">adoptFd</span><span class="p">(</span><span class="n">jniCreate</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="na">mtu</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">String</span><span class="w"> </span><span class="n">interfaze</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jniGetName</span><span class="p">(</span><span class="n">tun</span><span class="p">.</span><span class="na">getFd</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// TEMP use the old jni calls until there is support for netd address setting</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">StringBuilder</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StringBuilder</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">LinkAddress</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">addresses</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">builder</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="s">&#34; &#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">builder</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">address</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">jniSetAddresses</span><span class="p">(</span><span class="n">interfaze</span><span class="p">,</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="na">toString</span><span class="p">())</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&#34;At least one address must be specified&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">Connection</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Connection</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mContext</span><span class="p">.</span><span class="na">bindServiceAsUser</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">connection</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="n">Context</span><span class="p">.</span><span class="na">BIND_AUTO_CREATE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">BIND_FOREGROUND_SERVICE</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="k">new</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">(</span><span class="n">mUserHandle</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&#34;Cannot bind &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">user</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// Set up forwarding and DNS rules.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// First attempt to do a seamless handover that only changes the interface name and</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// parameters. If that fails, disconnect.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oldConfig</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">updateLinkPropertiesInPlaceIfPossible</span><span class="p">(</span><span class="n">mNetworkAgent</span><span class="p">,</span><span class="w"> </span><span class="n">oldConfig</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="c1">// Keep mNetworkAgent unchanged</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">mNetworkAgent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">updateState</span><span class="p">(</span><span class="n">DetailedState</span><span class="p">.</span><span class="na">CONNECTING</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;establish&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="c1">// Set up forwarding and DNS rules.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">agentConnect</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RuntimeException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">Log</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Established by &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">user</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; on &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mInterface</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">tun</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>忽略重重的<code>check</code>函数之后，关键在于<code>jniCreate</code>创建了fd</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//file: frameworks/base/services/core/jni/com_android_server_connectivity_Vpn.cpp 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="k">const</span> <span class="n">JNINativeMethod</span> <span class="n">gMethods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;jniCreate&#34;</span><span class="p">,</span> <span class="s">&#34;(I)I&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">create</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;jniGetName&#34;</span><span class="p">,</span> <span class="s">&#34;(I)Ljava/lang/String;&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">getName</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;jniSetAddresses&#34;</span><span class="p">,</span> <span class="s">&#34;(Ljava/lang/String;Ljava/lang/String;)I&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">setAddresses</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;jniReset&#34;</span><span class="p">,</span> <span class="s">&#34;(Ljava/lang/String;)V&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">reset</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;jniCheck&#34;</span><span class="p">,</span> <span class="s">&#34;(Ljava/lang/String;)I&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">check</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;jniAddAddress&#34;</span><span class="p">,</span> <span class="s">&#34;(Ljava/lang/String;Ljava/lang/String;I)Z&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">addAddress</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;jniDelAddress&#34;</span><span class="p">,</span> <span class="s">&#34;(Ljava/lang/String;Ljava/lang/String;I)Z&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">delAddress</span><span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">jint</span> <span class="nf">create</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="cm">/* thiz */</span><span class="p">,</span> <span class="n">jint</span> <span class="n">mtu</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">tun</span> <span class="o">=</span> <span class="nf">create_interface</span><span class="p">(</span><span class="n">mtu</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">tun</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throwException</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">tun</span><span class="p">,</span> <span class="s">&#34;Cannot create interface&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">tun</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">create_interface</span><span class="p">(</span><span class="kt">int</span> <span class="n">mtu</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">tun</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/tun&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_NONBLOCK</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ifreq</span> <span class="n">ifr4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifr4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ifr4</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Set MTU if it is specified.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ifr4</span><span class="p">.</span><span class="n">ifr_mtu</span> <span class="o">=</span> <span class="n">mtu</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nf">ioctl</span><span class="p">(</span><span class="n">inet4</span><span class="p">,</span> <span class="n">SIOCSIFMTU</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr4</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">ALOGE</span><span class="p">(</span><span class="s">&#34;Cannot set MTU on %s: %s&#34;</span><span class="p">,</span> <span class="n">ifr4</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="nf">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">tun</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">error</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">tun</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SYSTEM_ERROR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>最终所做的操作是打开了<code>/dev/tun</code>这个文件，设置mtu并返回fd（和官方所描述的一样）。</p>
<p><strong>那么什么是tun呢?</strong></p>
<p><code>tap/tun</code>是Linux内核2.4.x版本之后实现的虚拟网络设备，不同于物理网卡，<code>tap/tun</code>虚拟网卡完全由软件来实现，功能和硬件实现完全没有差别，它们同属于网络设备，可以配置IP，都归Linux网络设备管理模块统一管理。唯一的差异在于</p>
<ul>
<li>tap是一个二层设备（或者以太网设备），只能处理二层的以太网帧；</li>
<li>tun是一个点对点的三层设备（或网络层设备），只能处理三层的IP数据包。</li>
</ul>
<p>作为网络设备，tap/tun也需要配套相应的驱动程序才能工作。tap/tun驱动程序包括两个部分，一个是字符设备驱动，一个是网卡驱动。这两部分驱动程序分工不太一样，字符驱动负责数据包在内核空间和用户空间的传送，网卡驱动负责数据包在TCP/IP网络协议栈上的传输和处理。</p>
<p><code>tap/tun</code>对应的字符设备文件分别为：</p>
<ul>
<li>tap：/dev/tap0</li>
<li>tun：/dev/tun0</li>
</ul>
<p>设备文件即充当了用户空间和内核空间通信的接口。当应用程序打开设备文件时，驱动程序就会创建并注册相应的虚拟设备接口，一般以<code>tunX</code>或<code>tapX</code>命名。当应用程序关闭文件时，驱动也会自动删除<code>tunX</code>和<code>tapX</code>设备，还会删除已经建立起来的路由等信息。</p>
<p><code>tap/tun</code>设备文件就像一个管道，一端连接着用户空间，一端连接着内核空间。当用户程序向文件<code>/dev/net/tun</code>或<code>/dev/tap0</code>写数据时，内核就可以从对应的<code>tunX</code>或<code>tapX</code>接口读到数据，反之，内核可以通过相反的方式向用户程序发送数据。</p>
<p><strong>VPN对于网络数据的影响</strong></p>
<p>参考<a href="https://www.cnblogs.com/yudar/p/4630958.html"target="_blank" rel="external nofollow noopener noreferrer">网络虚拟化技术（二）: TUN/TAP MACVLAN MACVTAP</a>，先来看看物理网卡是如何工作的：</p>
<p><img loading="lazy" src="/posts/packet/vpn1.png" alt="/posts/packet/vpn1.png" srcset="/posts/packet/vpn1.png?size=small, /posts/packet/vpn1.png?size=medium 1.5x, /posts/packet/vpn1.png?size=large 2x" data-title="/posts/packet/vpn1.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>正常的网卡通过网线来收发数据包，所有物理网卡收到的数据包会交给内核的Network Stack处理，然后通过Socket API通知给用户程序。</p>
<p>看看tun的工作方式</p>
<p><img loading="lazy" src="/posts/packet/vpn2.png" alt="/posts/packet/vpn2.png" srcset="/posts/packet/vpn2.png?size=small, /posts/packet/vpn2.png?size=medium 1.5x, /posts/packet/vpn2.png?size=large 2x" data-title="/posts/packet/vpn2.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>但是tun设备通过一个<code>/dev/tunX</code>文件收发数据包。所有对该文件的写操作会通过tun设备转换成一个数据包送给内核；当内核发送一个包给tun设备时，通过读这个文件可以拿到包的内容。</p>
<p>如果我们使用tun设备搭建一个基于<code>UDP VPN</code>，那么整个处理过程就是这样：</p>
<p><img loading="lazy" src="/posts/packet/vpn3.png" alt="/posts/packet/vpn3.png" srcset="/posts/packet/vpn3.png?size=small, /posts/packet/vpn3.png?size=medium 1.5x, /posts/packet/vpn3.png?size=large 2x" data-title="/posts/packet/vpn3.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>数据包会通过内核网络栈两次。但是经过App的处理后，数据包可能已经加密，并且原有的ip头被封装在udp内部，所以第二次通过网络栈内核看到的是截然不同的网络包。</p>
<p>tap/tun通过实现相应的网卡驱动程序来和网络协议栈通信。一般的流程和物理网卡和协议栈的交互流程是一样的，不同的是物理网卡一端是连接物理网络，而tap/tun虚拟网卡一般连接到用户空间。</p>
<p><strong>一个简单的案例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">+----------------------------------------------------------------+
</span></span><span class="line"><span class="cl">|                                                                |
</span></span><span class="line"><span class="cl">|  +--------------------+      +--------------------+            |
</span></span><span class="line"><span class="cl">|  | User Application A |      | User Application B |&lt;-----+     |
</span></span><span class="line"><span class="cl">|  +--------------------+      +--------------------+      |     |
</span></span><span class="line"><span class="cl">|               | 1                    | 5                 |     |
</span></span><span class="line"><span class="cl">|...............|......................|...................|.....|
</span></span><span class="line"><span class="cl">|               ↓                      ↓                   |     |
</span></span><span class="line"><span class="cl">|         +----------+           +----------+              |     |
</span></span><span class="line"><span class="cl">|         | socket A |           | socket B |              |     |
</span></span><span class="line"><span class="cl">|         +----------+           +----------+              |     |
</span></span><span class="line"><span class="cl">|                 | 2               | 6                    |     |
</span></span><span class="line"><span class="cl">|.................|.................|......................|.....|
</span></span><span class="line"><span class="cl">|                 ↓                 ↓                      |     |
</span></span><span class="line"><span class="cl">|             +------------------------+                 4 |     |
</span></span><span class="line"><span class="cl">|             | Newwork Protocol Stack |                   |     |
</span></span><span class="line"><span class="cl">|             +------------------------+                   |     |
</span></span><span class="line"><span class="cl">|                | 7                 | 3                   |     |
</span></span><span class="line"><span class="cl">|................|...................|.....................|.....|
</span></span><span class="line"><span class="cl">|                ↓                   ↓                     |     |
</span></span><span class="line"><span class="cl">|        +----------------+    +----------------+          |     |
</span></span><span class="line"><span class="cl">|        |      eth0      |    |      tun0      |          |     |
</span></span><span class="line"><span class="cl">|        +----------------+    +----------------+          |     |
</span></span><span class="line"><span class="cl">|    10.32.0.11  |                   |   192.168.3.11      |     |
</span></span><span class="line"><span class="cl">|                | 8                 +---------------------+     |
</span></span><span class="line"><span class="cl">|                |                                               |
</span></span><span class="line"><span class="cl">+----------------|-----------------------------------------------+
</span></span><span class="line"><span class="cl">                 ↓
</span></span><span class="line"><span class="cl">         Physical Network</span></span></code></pre></td></tr></table>
</div>
</div><p>上图中有两个应用程序A和B，都在用户层，而其它的socket、协议栈（Newwork Protocol Stack）和网络设备（eth0和tun0）部分都在内核层，其实socket是协议栈的一部分，这里分开来的目的是为了看的更直观。</p>
<p>tun0是一个Tun/Tap虚拟设备，从上图中可以看出它和物理设备eth0的差别，它们的一端虽然都连着协议栈，但另一端不一样，eth0的另一端是物理网络，这个物理网络可能就是一个交换机，而tun0的另一端是一个用户层的程序，协议栈发给tun0的数据包能被这个应用程序读取到，并且应用程序能直接向tun0写数据。</p>
<p>上图中有两个应用程序A和B，都在用户层，而其它的socket、协议栈（Newwork Protocol Stack）和网络设备（eth0和tun0）部分都在内核层，其实socket是协议栈的一部分，这里分开来的目的是为了看的更直观。</p>
<p>tun0是一个Tun/Tap虚拟设备，从上图中可以看出它和物理设备eth0的差别，它们的一端虽然都连着协议栈，但另一端不一样，eth0的另一端是物理网络，这个物理网络可能就是一个交换机，而tun0的另一端是一个用户层的程序，协议栈发给tun0的数据包能被这个应用程序读取到，并且应用程序能直接向tun0写数据。</p>
<p>这里假设eth0配置的IP是<code>10.32.0.11</code>，而tun0配置的IP是<code>192.168.3.11</code>.</p>
<blockquote>
<p>这里列举的是一个典型的tun/tap设备的应用场景，发到192.168.3.0/24网络的数据通过程序B这个隧道，利用10.32.0.11发到远端网络的10.33.0.1，再由10.33.0.1转发给相应的设备，从而实现VPN。</p></blockquote>
<p>下面来看看数据包的流程：</p>
<ol>
<li>应用程序A是一个普通的程序，通过socket A发送了一个数据包，假设这个数据包的目的IP地址是192.168.3.1</li>
<li>socket将这个数据包丢给协议栈</li>
<li>协议栈根据数据包的目的IP地址，匹配本地路由规则，知道这个数据包应该由tun0出去，于是将数据包交给tun0</li>
<li>tun0收到数据包之后，发现另一端被进程B打开了，于是将数据包丢给了进程B</li>
<li>进程B收到数据包之后，做一些跟业务相关的处理，然后构造一个新的数据包，将原来的数据包嵌入在新的数据包中，最后通过socket B将数据包转发出去，这时候新数据包的源地址变成了eth0的地址，而目的IP地址变成了一个其它的地址，比如是10.33.0.1.</li>
<li>socket B将数据包丢给协议栈</li>
<li>协议栈根据本地路由，发现这个数据包应该要通过eth0发送出去，于是将数据包交给eth0</li>
<li>eth0通过物理网络将数据包发送出去</li>
</ol>
<p>10.33.0.1收到数据包之后，会打开数据包，读取里面的原始数据包，并转发给本地的192.168.3.1，然后等收到192.168.3.1的应答后，再构造新的应答包，并将原始应答包封装在里面，再由原路径返回给应用程序B，应用程序B取出里面的原始应答包，最后返回给应用程序A</p>
<p>从上面的流程中可以看出，数据包选择走哪个网络设备完全由路由表控制，所以如果我们想让某些网络流量走应用程序B的转发流程，就需要配置路由表让这部分数据走tun0。</p>
<h4 id="222-使用方式" class="heading-element"><span>2.2.2 使用方式</span>
  <a href="#222-%e4%bd%bf%e7%94%a8%e6%96%b9%e5%bc%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>使用方式有两种思路</p>
<ol>
<li>
<p>设备本地VPN抓包解析：数据包直接在本地解析，不转发到额外的服务器，无需利用其他设备，分析简单直接。</p>
</li>
<li>
<p>设备本地VPN抓包-转发外部服务器解析：和本地解析相比，指定VPN服务器一般都是主机/服务器的形式，拥有更强的数据处理能力且支持多台设备统一处理，常见的方案是<code>Charles</code>+<code>Postern</code>，由Charles在PC端建立socket服务器，Postern在本地建立VPN拦截数据包转发到Charles上，Charles又可以提供实时解析数据包的能力（VPN软件不受限，像大部分翻墙软件都可以）。</p>
</li>
</ol>
<h4 id="223-防御与对抗" class="heading-element"><span>2.2.3 防御与对抗</span>
  <a href="#223-%e9%98%b2%e5%be%a1%e4%b8%8e%e5%af%b9%e6%8a%97" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>由于VPN是基于系统实现的网络层流量拦截，因此普通App对这种行为的反抗能力几乎是没有（无法强制流量绕过），但是由于这种实现是基本VPN方案的，因此比较有效的对抗方式是检测VPN。</p>
<h3 id="23-数据链路层网关路由" class="heading-element"><span>2.3 数据链路层：网关（路由）</span>
  <a href="#23-%e6%95%b0%e6%8d%ae%e9%93%be%e8%b7%af%e5%b1%82%e7%bd%91%e5%85%b3%e8%b7%af%e7%94%b1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>相比于在设备上实现虚拟网卡的方案存在明显的VPN特征来说，在设备外的网关层（路由）进行抓包可以完美的实现设备无感知。</p>
<h4 id="231-原理" class="heading-element"><span>2.3.1 原理</span>
  <a href="#231-%e5%8e%9f%e7%90%86" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><h4 id="232-使用方式" class="heading-element"><span>2.3.2 使用方式</span>
  <a href="#232-%e4%bd%bf%e7%94%a8%e6%96%b9%e5%bc%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>使用方式的思路主要区别在于确定路由器是什么，例如下列这几种常见的方案：</p>
<ol>
<li>
<p>普通PC都会自带无线网卡，基于PC端开启的热点作为路由器，让设备连接该热点，再通过<code>Wireshark</code>指定无线网卡进行抓包</p>
</li>
<li>
<p>使用类似360随身WiFi，插到PC上提供热点功能，再通过<code>Wireshark</code>指定无线网卡进行抓包</p>
</li>
<li>
<p>将闲置的PC或者路由器刷成Openwrt系统，使用<code>tcpdump</code>指定无线网卡进行抓包</p>
</li>
<li>
<p><a href="https://gist.github.com/snakevil/7d7af1d8ca2c739e3fedc5b15eb8e4aa"target="_blank" rel="external nofollow noopener noreferrer">使用树莓派3B打造超强路由</a></p>
</li>
</ol>
<h4 id="233-防御与对抗" class="heading-element"><span>2.3.3 防御与对抗</span>
  <a href="#233-%e9%98%b2%e5%be%a1%e4%b8%8e%e5%af%b9%e6%8a%97" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>单从防御流量抓取维度上来说无法对抗</p>
<h3 id="24-数据链路层libpcap" class="heading-element"><span>2.4 数据链路层：libpcap</span>
  <a href="#24-%e6%95%b0%e6%8d%ae%e9%93%be%e8%b7%af%e5%b1%82libpcap" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>在前文中网关（路由）抓包和虚拟网卡抓包的方式中，都可以使用<code>tcpdump</code>进行抓包，前者需要指定网卡为热点网卡（AP），后者指定为虚拟网卡（TUN）即可。这样抓包出来的结果是一个<code>pcap</code>文件，一般直接丢到<code>Wireshark</code>里面去进行分析。与前面的方法相比，这种方法对于<code>HTTP</code>的可视化解析可能相对简陋，但是对于协议类型的支持却非常广泛，基本上你能叫出名字的标准协议都可以进行解析。</p>
<p><code>tcpdump</code>本质上是基于<code>libpcap</code>实现的</p>
<h4 id="241-原理" class="heading-element"><span>2.4.1 原理</span>
  <a href="#241-%e5%8e%9f%e7%90%86" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>libpcap主要由两部份组成：<strong>网络分接头(Network Tap)<strong>和</strong>数据过滤器(Packet Filter)</strong>。</p>
<ul>
<li>网络分接头从网络设备驱动中收集数据拷贝</li>
<li>过滤器决定是否接收该数据包</li>
</ul>
<p>网络分接头从网络设备驱动程序（<code>NIC driver</code>）中收集数据拷贝，过滤器决定是否接收该数据包。<code>libpcap</code>利用<code>BSD Packet Filter</code>（也就是通常说的<code>BPF</code>）对网卡接收到的链路层数据包进行过滤。</p>
<p><img loading="lazy" src="/posts/packet/libpcap1.png" alt="/posts/packet/libpcap1.png" srcset="/posts/packet/libpcap1.png?size=small, /posts/packet/libpcap1.png?size=medium 1.5x, /posts/packet/libpcap1.png?size=large 2x" data-title="/posts/packet/libpcap1.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>从整体流程中可以看出<code>libpcap</code>的两个部分</p>
<p><strong>Network Tap</strong></p>
<p><code>libpcap</code>是数据链路层<code>PF_PACKET</code>协议的标准实现，向网卡驱动注册一个<code>PF_PACKET</code>类型的socket，后续就可以持续的从该socket中获取到网卡驱动分发的数据包，而且从图中也可以看出，<code>PF_PACKET</code>类型和正常的<code>PF_INET</code>类型是有差异的，<code>PF_INET</code>主要服务于系统网络协议栈，<code>PF_PACKET</code>类型作为旁路流量处理，支持独立于系统网络栈单独处理流量。</p>
<p><img loading="lazy" src="/posts/packet/libpcap3.png" alt="/posts/packet/libpcap3.png" srcset="/posts/packet/libpcap3.png?size=small, /posts/packet/libpcap3.png?size=medium 1.5x, /posts/packet/libpcap3.png?size=large 2x" data-title="/posts/packet/libpcap3.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><strong>Packet Filter</strong></p>
<p><code>Packet Filter</code>在内核层根据指定规则利用BPF机制完成数据包的过滤，使用共享内存方式，在内核空间中分配一块内核缓冲区，然后用户空间程序调用mmap映射到用户空间完成数据包的读取。</p>
<p><img loading="lazy" src="/posts/packet/libpcap2.png" alt="/posts/packet/libpcap2.png" srcset="/posts/packet/libpcap2.png?size=small, /posts/packet/libpcap2.png?size=medium 1.5x, /posts/packet/libpcap2.png?size=large 2x" data-title="/posts/packet/libpcap2.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h4 id="242-使用方式" class="heading-element"><span>2.4.2 使用方式</span>
  <a href="#242-%e4%bd%bf%e7%94%a8%e6%96%b9%e5%bc%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>可以参考<a href="https://tcc0lin.github.io/posts/e319adc/#512-%E5%AE%8C%E5%85%A8%E8%87%AA%E7%A0%94%E5%8D%8F%E8%AE%AE%E7%9A%84%E8%AE%BE%E8%AE%A1%E7%89%B9%E5%BE%81"target="_blank" rel="external nofollow noopener noreferrer">协议特征提取</a>中提及到的针对App uid抓包的方式可以过滤掉非目标流量的干扰</p>
<h4 id="243-防御与对抗" class="heading-element"><span>2.4.3 防御与对抗</span>
  <a href="#243-%e9%98%b2%e5%be%a1%e4%b8%8e%e5%af%b9%e6%8a%97" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>单从防御流量抓取维度上来说无法对抗</p>
<h2 id="三协议解析" class="heading-element"><span>三、协议解析</span>
  <a href="#%e4%b8%89%e5%8d%8f%e8%ae%ae%e8%a7%a3%e6%9e%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>上节中介绍了流量抓取的一些方案，现在目光转向协议解析上，排除某类App使用到的定制加密协议外（例如微信的mmtls等），标准的<code>TLS</code>协议解密同样是一个在终端流量对抗中很严峻的课题，一般来说，目前存在以下几种防御方式：</p>
<ol>
<li>
<p>客户端验证服务端的证书链可信，这是在TLS握手阶段的必要操作；</p>
<ul>
<li>证书链扩展：可以选择系统证书链验证或者自建证书链验证；</li>
</ul>
</li>
<li>
<p>服务端验证客户端的证书可信(Certificate Request)，又称为双向证书绑定；</p>
</li>
<li>
<p>客户端验证服务端的证书<code>HASH</code>是否在白名单中，即<code>SSL Pinning</code>；</p>
</li>
<li>
<p>……</p>
</li>
</ol>
<p>在介绍后文的具体解密方案中也会围绕这几点去进行分析。</p>
<h3 id="31-根证书" class="heading-element"><span>3.1 根证书</span>
  <a href="#31-%e6%a0%b9%e8%af%81%e4%b9%a6" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>添加自定义的根证书应该是<code>HTTPS</code>流量分析的标准答案了。前文中提到的<code>Burpsuite</code>等工具的文档中肯定都有介绍如何添加自定义根证书，根证书的存放对于不同的操作系统甚至不同的应用都有不同路径。比如</p>
<ul>
<li>在<code>Android</code>中，根证书存放在<code>/system/etc/security/cacerts</code>目录之下；</li>
<li>在<code>ios/MacOS</code>中，根证书存放在<code>Keychain</code>中；</li>
<li>对于<code>Chrome</code>浏览器，其应用中打包了证书链，不使用系统的证书；</li>
<li>……</li>
</ul>
<p>至于如何添加根证书，可以自行搜索，这里就不再啰嗦了。虽然添加自定义根证书可以让我们很方便地使用代理工具进行<code>HTTPS</code>流量分析，但其实际上只解决了第一个问题，因此对于某些做了额外校验的应用而言<code>TLS</code>握手还是无法成功的。</p>
<p>如果目标应用服务器在<code>TLS</code>握手中校验了客户端证书，那么我们还需要在代理工具中添加对应私钥才能顺利完成握手。该证书一般以<code>p12</code>格式存放，包含了客户端的证书及其私钥，通常还有一个额外的密码。通过逆向分析目标应用的的加载代码往往不难发现客户端证书的踪迹，甚至有时可以直接在资源文件中找到。</p>
<p>如果目标应用使用了<code>SSL Pinning</code>加固，那么通常是将服务器的证书<code>HASH</code>保存在代码中，并在握手之后进行额外校验。</p>
<p>由于相关数据<code>证书HASH</code>和逻辑都在代码中，因此这种情况下往往只能通过侵入式的方式去绕过<code>Pinning</code>校验，比如<code>Patch</code>代码或者使用<code>hook</code>等方法实现。</p>
<p>由于这是一个较为常见的功能，因此网上有很多相关脚本可以实现常规的<code>SSL Pinning bypass</code>，例如<code>JustTrustMe系列</code>以及<code>Objection</code>工具提供的<code>android sslpinning disable</code>功能等等，但需要注意的是这并不意味着可以100%绕过，对于一些特殊实现仍然需要进行特殊分析。</p>
<h3 id="32-ssl-keylog" class="heading-element"><span>3.2 SSL keylog</span>
  <a href="#32-ssl-keylog" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>除了在端侧添加自定义根证书完成<code>MITM攻击</code>以外，还有一种方式可以解密<code>SSL/TLS</code>的流量，即在握手过程中想办法获取到<code>TLS</code>会话的 <code>Master Key</code>，根据协商的加密套件，就可以对整个<code>TLS stream</code>进行解密。关于<code>TLS</code>握手的原理介绍，可以参考笔者上一篇文章 —— <a href="https://tcc0lin.github.io/posts/e319adc/"target="_blank" rel="external nofollow noopener noreferrer">TLS协议握手与协议组合的深度解构：从TLS协议到定制化加密协议的移动安全视角</a>。</p>
<p>知名的抓包和网络协议分析工具 <code>Wireshark</code> 就支持通过添加 <code>keylog</code> 文件去辅助 TLS 流量的解密。这里的<code>keylog</code>就是 <a href="https://wiki.wireshark.org/TLS"target="_blank" rel="external nofollow noopener noreferrer">TLS 会话秘钥</a>，文件格式为 <a href="https://firefox-source-docs.mozilla.org/security/nss/legacy/key_log_format/index.html"target="_blank" rel="external nofollow noopener noreferrer">NSS Key Log Format</a>。对于不同版本的<code>TLS</code>内容略有不同</p>
<ul>
<li>在<code>TLS 1.2</code>中只需要一个会话的<code>MasterKey</code>，使用<code>CLIENT_RANDOM</code>去区分不同会话；</li>
<li>在<code>TLS 1.3</code>中每个会话包含5个秘钥，分别用于解密握手、数据阶段的不同数据。</li>
</ul>
<p>那么，这个<code>keylog</code>文件我们应该如何获取呢？对于大部分<code>keylog</code>库而言，比如<code>OpenSSL``、BoringSSL</code>、<code>libreSSL</code>等，都可以通过 <a href="https://www.openssl.org/docs/man1.1.1/man3/SSL_CTX_set_keylog_callback.html"target="_blank" rel="external nofollow noopener noreferrer">SSL_CTX_set_keylog_callback</a> 这个<code>API</code>去设置获取的回调，令<code>SSL</code>库在握手成功后调用对应的回调函数从而获取<code>keylog</code>。因此我们就需要通过静态<code>patch</code>或者动态<code>hook</code>的方式去为<code>TLS</code>添加该回调。</p>
<p>这看似很简单，但实际操作起来会遇到一些问题。比如，很多大型商业应用都封装了自己的<code>SSL</code>库，甚至同一个应用中不同组件中又间接包含了有多个<code>SSL</code>库，为了每一个<code>TLS</code>会话都能成功解密，需要确保每个<code>SSL</code>库都要被正确<code>patch</code>或者<code>hook</code>；</p>
<p>其次，对于某些App而言，它们会将系统网络库实现全都下沉到Native中，也就相应的通过静态编译的方式引入<code>SSL</code>库，同时针对网络库进行代码保护。那么我们可能需要通过一些方法去搜索定位所需的符号地址。这个任务的难度可大可小，简单的可以通过<code>yara</code>、<code>Bindiff</code>去进行定位，复杂的话也可以通过一些深度学习算法去进行相似度分析，比如科恩的<code>BinaryAI</code>或者阿里云的<code>Finger</code>等。感兴趣的也可以去进一步阅读相关的综述文章:</p>
<blockquote>
<p><a href="https://www.eurecom.fr/publication/6847/download/sec-publi-6847.pdf"target="_blank" rel="external nofollow noopener noreferrer">USENIX Security 2022 - How Machine Learning Is Solving the Binary Function Similarity Problem</a></p></blockquote>
<p>虽然有这些那些难点，但这种解密方法的一大优点是可以一次性解决本节开头所提及的三个问题，即<strong>服务端证书校验</strong>、<strong>客户端证书校验</strong>和<strong>SSL Pinning</strong>。因为该方法并非是<code>MITM攻击</code>，而是在应用的运行过程中主动泄露会话秘钥，因此不会影响上层的证书校验。</p>
<h3 id="33-ssl-readwrite" class="heading-element"><span>3.3 SSL read/write</span>
  <a href="#33-ssl-readwrite" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>既然设置<code>keylog</code>如此麻烦，为什么不找一些相对简单且通用的<code>API</code>去进行解密呢？一个直接的思路就是通过挂钩 <a href="https://www.openssl.org/docs/man1.1.1/man3/SSL_read.html"target="_blank" rel="external nofollow noopener noreferrer">SSL_read</a>、<a href="https://docs.openssl.org/1.1.1/man3/SSL_write/"target="_blank" rel="external nofollow noopener noreferrer">SSL_write</a>来获取<code>SSL</code>读写的明文数据。基于这个思路目前网上有许多工程化的实现，比如</p>
<ul>
<li>
<p><a href="https://github.com/ehids/ecapture"target="_blank" rel="external nofollow noopener noreferrer">eCapture</a> 是基于<code>eBPF/uprobes</code>的<code>TLS</code>抓包方案；</p>
</li>
<li>
<p><a href="https://github.com/r0ysue/r0capture"target="_blank" rel="external nofollow noopener noreferrer">r0capture</a> 则是基于<code>frida</code>注入的<code>TLS</code>抓包方案。</p>
</li>
</ul>
<p>使用该方法进行解密的一大优点，或者说特点，是这种方式可以在解密的同时直接输出明文信息，因此可以完全略过<strong>流量抓取</strong>这一步。虽然许多开源工具是将结果保存为<code>pcap</code>文件进行进一步分析的，但实际上也可以直接在标准输出或者日志文件中打印出来进行分析。</p>
<p>由于这些抓包工具本质上都是在获取<code>SSL read/write</code>明文的基础上再以<code>pcap</code>格式进行转储，因此同样会面临<code>keylog</code>方案所面临的问题，即依赖<code>SSL</code>库的符号。但不同的是其所依赖的是较为通用的符号，因此不太会受到<code>SSL</code>库版本的限制。唯一需要考虑的难题是如何解析无符号的<code>SSL</code>库中相关函数的偏移地址，这个后续会再开个文章细说。</p>
<h2 id="总结" class="heading-element"><span>总结</span>
  <a href="#%e6%80%bb%e7%bb%93" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>上述介绍的每一种流量抓取方法都可以和任意一种流量解密方法相结合，组成一种网络流量分析方案。实践上使用较多的是下面几种组合:</p>
<ul>
<li>系统HTTP代理 + 根证书</li>
<li>路由抓包/透明代理 + 根证书</li>
<li>tcpdump + keylog</li>
<li>SSL_read/SSL_write hook</li>
</ul>
<p>每种方案都有其优点和缺点:</p>
<table>
  <thead>
      <tr>
          <th>抓包方案</th>
          <th>优点</th>
          <th>缺点</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>系统代理</td>
          <td>配置简单，工具成熟</td>
          <td>可被忽略，流量不全，证书问题</td>
      </tr>
      <tr>
          <td>路由抓包</td>
          <td>流量完整，应用透明</td>
          <td>配置复杂，协议受限，证书问题</td>
      </tr>
      <tr>
          <td>tcpdump + keylog</td>
          <td>流量完整，无需证书协议丰富，应用过滤</td>
          <td>TLS 解密需要hook应用且依赖于 SSL 库的版本和符号</td>
      </tr>
      <tr>
          <td>SSL read/write</td>
          <td>劫持简单，无需证书</td>
          <td>需要(某些)符号，依赖hook，流量不全</td>
      </tr>
  </tbody>
</table>
<p>那么实际安全分析中要如何选择呢？正如那句老话所说: <strong>网络安全没有银弹</strong>，实际情况也无法一概而论，通常是根据具体的目标去进行分析。</p>
<p>总而言之，根据现有的梳理</p>
<ul>
<li>
<p>流量抓取可以100%的放心，因为已有足够稳定的方案可以确保网络流量的完备性，即App所产生的所有网络交互都能够确保被抓到</p>
</li>
<li>
<p>协议解析在App使用常规的<code>HTTP</code>类协议的前提下也能够保证稳定的解析，但是不能排除App使用存在多种协议混用的情况，因此需要在不同的场景中灵活处理。</p>
</li>
</ul>
<h2 id="参考" class="heading-element"><span>参考</span>
  <a href="#%e5%8f%82%e8%80%83" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ol>
<li><a href="https://bbs.kanxue.com/thread-252161-1.htm#msg_header_h2_2"target="_blank" rel="external nofollow noopener noreferrer">Android4.4 wifi代理流程</a></li>
<li><a href="https://itimetraveler.github.io/2019/07/25/%E3%80%90Android%E3%80%91%E4%BD%BF%E7%94%A8VPN%E5%AE%9E%E7%8E%B0%E6%8A%93%E5%8C%85/#TUN-TAP%E6%98%AF%E4%BB%80%E4%B9%88"target="_blank" rel="external nofollow noopener noreferrer">【Android】 使用VPN实现抓包</a></li>
<li><a href="https://jgsun.github.io/2019/01/21/linux-tcpdump/"target="_blank" rel="external nofollow noopener noreferrer">图解linux tcpdump</a></li>
<li><a href="https://blog.csdn.net/sdgdsczs/article/details/129365078"target="_blank" rel="external nofollow noopener noreferrer">网卡多队列绑定中断的方式优化网络吞吐
</a></li>
<li><a href="https://tcc0lin.github.io/posts/e319adc/"target="_blank" rel="external nofollow noopener noreferrer">TLS协议握手与协议组合的深度解构：从TLS协议到定制化加密协议的移动安全视角</a></li>
</ol></div><hr class="awesome-hr" />
    <h2 id="see-also">相关内容</h2>
    <ul><li>
          <a href="/posts/e319adc/" title="TLS协议握手与协议组合的深度解构：从TLS协议到定制化加密协议的移动安全视角">TLS协议握手与协议组合的深度解构：从TLS协议到定制化加密协议的移动安全视角</a></li><li>
          <a href="/posts/linux-kprobe%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/" title="Linux Kprobe原理探究">Linux Kprobe原理探究</a></li><li>
          <a href="/posts/lsplant%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/" title="LSPlant源码学习">LSPlant源码学习</a></li><li>
          <a href="/posts/dobby%E6%A1%86%E6%9E%B6%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/" title="Dobby框架源码学习">Dobby框架源码学习</a></li><li>
          <a href="/posts/%E4%BB%8Erfc1321%E4%B8%AD%E7%90%86%E8%A7%A3md5%E7%AE%97%E6%B3%95/" title="从RFC1321中理解MD5算法">从RFC1321中理解MD5算法</a></li></ul><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2025-03-26 20:57:27">更新于 2025-03-26&nbsp;</span>
      </div></div><div class="post-info-line">
        <div class="post-info-md"><span><a href="/posts/19081ef/index.md" title="阅读原始文档" class="link-to-markdown">阅读原始文档</a></span></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="分享到 X" data-sharer="twitter" data-url="http://localhost:1313/posts/19081ef/" data-title="终端流量对抗的经验总结" data-hashtags="流量对抗"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="http://localhost:1313/posts/19081ef/" data-hashtag="流量对抗"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="http://localhost:1313/posts/19081ef/" data-title="终端流量对抗的经验总结"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/%E6%B5%81%E9%87%8F%E5%AF%B9%E6%8A%97/" class="post-tag" title="标签 - 流量对抗">流量对抗</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div><div class="post-nav"><a href="/posts/e319adc/" class="post-nav-item" rel="next" title="TLS协议握手与协议组合的深度解构：从TLS协议到定制化加密协议的移动安全视角">TLS协议握手与协议组合的深度解构：从TLS协议到定制化加密协议的移动安全视角<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.145.0"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.16"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2021 - 2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/">tcc0lin</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div><div class="footer-line statistics"><span class="site-time" title='网站运行中……'><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden="true"></i><span class="run-times ms-1">网站运行中……</span></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div></div><a href="https://github.com/tcc0lin" title="View source on GitHub"target="_blank" rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true" width="56" height="56"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;width: calc(100% - var(--progress));"></div><noscript>
    <div class="noscript-warning">该网站在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/instant-page/instantpage.min.js" async defer type="module"></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":50},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/search.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"没有找到结果","snippetLength":30,"threshold":0.3,"type":"fuse","useExtendedSearch":false},"siteTime":"2021-12-18T16:15:22+08:00","typeit":{"cursorChar":"|","cursorSpeed":1000,"duration":-1,"loop":false,"speed":100},"version":"v0.3.16"};</script><script src="/js/theme.min.js" defer></script></body>
</html>
